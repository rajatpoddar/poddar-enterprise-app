<!-- File: templates/employee/dashboard.html -->
{% extends 'layout.html' %}
{% block title %}Your Dashboard{% endblock %}

{% block content %}
<!-- Balance Info -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
        <h2 class="mb-0">Welcome, {{ g.user.name }}</h2>
    </div>
    <div class="card-body">
        <div class="row text-center">
            <div class="col-sm-4 mb-3 mb-sm-0">
                 <div class="p-2 border rounded">
                    <h6 class="text-muted">Total Approved Wages</h6>
                    <p class="fs-4 fw-bold mb-0">₹{{ "%.2f"|format(balance_info.earned_wages) }}</p>
                </div>
            </div>
             <div class="col-sm-4 mb-3 mb-sm-0">
                 <div class="p-2 border rounded">
                    <h6 class="text-muted">Total Paid/Advanced</h6>
                    <p class="fs-4 fw-bold mb-0">₹{{ "%.2f"|format(balance_info.total_paid) }}</p>
                </div>
            </div>
            <div class="col-sm-4">
                 <div class="p-2 border rounded {{ 'bg-success-subtle' if balance_info.amount_due >= 0 else 'bg-danger-subtle' }}">
                    <h6 class="text-muted">Current Balance Due to You</h6>
                    <p class="fs-4 fw-bold mb-0">₹{{ "%.2f"|format(balance_info.amount_due|abs) }}</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Attendance Marking -->
<div id="attendance-section" class="card shadow-sm mb-4">
    <div class="card-header"><h4 class="mb-0">Mark Your Attendance</h4></div>
    <div class="card-body">
        <!-- --- FIX: Dynamic status message --- -->
        {% if has_ended %}
            {% if ended_rec.attendance_status == 'approved' %}
                <div class="alert alert-success text-center">Thank you! Your attendance for today has been <strong>approved</strong>.</div>
            {% elif ended_rec.attendance_status == 'rejected' %}
                 <div class="alert alert-danger text-center">Your attendance for today has been <strong>rejected</strong>. Please check with your manager.</div>
            {% else %}
                <div class="alert alert-info text-center">Thank you! Your attendance for today is complete and <strong>pending approval</strong>.</div>
            {% endif %}
        {% else %}
        <form id="attendanceForm" action="{{ url_for('mark_attendance') }}" method="post">
            <div id="camera-container" class="mb-3 text-center" style="display: none;">
                <video id="video" width="100%" style="max-width: 400px;" height="auto" autoplay playsinline class="rounded border"></video>
                <canvas id="canvas" style="display:none;"></canvas>
            </div>
            <input type="hidden" name="event_type" id="event_type">
            <input type="hidden" name="photo" id="photo">
            <div id="status-container" class="mt-3 text-center"></div>
            <div class="d-grid gap-3 mt-4" id="button-container">
                <button type="button" id="startBtn" class="btn btn-success btn-lg" data-event="Start" {% if has_started %}disabled{% endif %}>Start Job</button>
                <button type="button" id="endBtn" class="btn btn-danger btn-lg" data-event="End" {% if not has_started or has_ended %}disabled{% endif %}>End Job</button>
            </div>
        </form>
        {% endif %}
    </div>
</div>

<!-- Today's Work Notes -->
{% if has_started and not has_ended %}
<div class="card shadow-sm mb-4">
    <div class="card-header"><h4 class="mb-0">Today's Work Notes (Required to End Job)</h4></div>
    <div class="card-body">
        <form action="{{ url_for('add_note') }}" method="post">
            <div class="mb-3">
                <textarea id="workNotes" name="notes" class="form-control" rows="3" placeholder="Enter details about your work today (e.g., location, tasks completed)..." required>{{ todays_note or '' }}</textarea>
            </div>
            <button type="submit" class="btn btn-primary">Save Note</button>
        </form>
    </div>
</div>
{% endif %}

<!-- Recent History -->
<div class="card shadow-sm">
    <div class="card-header"><h4 class="mb-0">Your Recent Attendance</h4></div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr><th>Photo</th><th>Date & Time (IST)</th><th>Event</th><th>Details</th><th>Status</th></tr>
                </thead>
                <tbody>
                {% for att in attendances %}
                    <tr>
                        <td>
                            {% if att.photo_path and att.photo_path not in ['no_photo.jpg', 'auto'] %}
                                <a href="{{ url_for('static', filename='uploads/' + att.photo_path) }}" target="_blank">
                                    <img src="{{ url_for('static', filename='uploads/' + att.photo_path) }}" alt="Check-in" width="50" class="rounded">
                                </a>
                            {% else %}<span class="text-muted">-</span>{% endif %}
                        </td>
                        <td>{{ att.timestamp | ist }}</td>
                        <td><span class="badge bg-{{ 'success' if att.event_type == 'Start' else 'danger' }}">{{ att.event_type }}</span></td>
                        <td>{{ att.details }}</td>
                        <td>
                            {% if att.attendance_status == 'pending' %}
                                <span class="badge bg-warning text-dark">Pending</span>
                            {% elif att.attendance_status == 'approved' %}
                                <span class="badge bg-success">Approved</span>
                            {% elif att.attendance_status == 'rejected' %}
                                <span class="badge bg-danger" title="Reason: {{ att.rejection_reason }}">Rejected</span>
                            {% endif %}
                        </td>
                    </tr>
                {% else %}
                    <tr><td colspan="5" class="text-center">No recent attendance.</td></tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const attendanceForm = document.getElementById('attendanceForm');
    if (!attendanceForm) return;

    const startBtn = document.getElementById('startBtn');
    const endBtn = document.getElementById('endBtn');
    const attendanceSection = document.getElementById('attendance-section');
    const statusDiv = document.getElementById('status-container');
    const form = document.getElementById('attendanceForm');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const photoInput = document.getElementById('photo');
    const cameraContainer = document.getElementById('camera-container');
    const workNotes = document.getElementById('workNotes');
    let stream;

    async function startCamera() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
        }
        try {
            statusDiv.innerHTML = `<div class="text-muted">Please allow camera access...</div>`;
            stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
            video.srcObject = stream;
            cameraContainer.style.display = 'block';
            statusDiv.innerHTML = ''; // Clear status on success
            return true;
        } catch (err) {
            statusDiv.innerHTML = `<div class="alert alert-danger">Camera access denied. Please allow camera permissions in your browser settings.</div>`;
            return false;
        }
    }

    const handleButtonClick = async (button) => {
        const eventType = button.getAttribute('data-event');

        // --- FEATURE: Make notes mandatory ---
        if (eventType === 'End') {
            // Also check the backend variable in case they haven't saved yet
            if (!workNotes || workNotes.value.trim() === '') {
                statusDiv.innerHTML = `<div class="alert alert-warning">Please enter and save your work notes before ending the job.</div>`;
                workNotes.focus();
                return;
            }
        }
        
        attendanceSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        button.disabled = true;
        button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Activating Camera...`;
        
        const cameraReady = await startCamera();
        if (!cameraReady) {
            button.disabled = false;
            button.innerHTML = eventType === 'Start' ? 'Start Job' : 'End Job';
            return;
        }

        button.innerHTML = `<span class="spinner-border spinner-border-sm"></span> Capturing Photo...`;
        
        setTimeout(() => {
            document.getElementById('event_type').value = eventType;
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            photoInput.value = canvas.toDataURL('image/jpeg');

            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
            
            form.submit();

        }, 500);
    };

    if(startBtn) startBtn.addEventListener('click', () => handleButtonClick(startBtn));
    if(endBtn) endBtn.addEventListener('click', () => handleButtonClick(endBtn));
});
</script>
{% endblock %}

