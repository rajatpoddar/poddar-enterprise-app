<!-- File: templates/manager/dashboard.html -->
{% extends 'layout.html' %}
{% block title %}Dashboard{% endblock %}
{% block content %}

<!-- NEW: Employee Balances and Quick Pay -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="bi bi-wallet2"></i> Employee Wages Due</h4>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Employee Name</th>
                        <th class="text-end">Amount Due</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for balance in employee_balances %}
                    <tr>
                        <td>
                            <a href="{{ url_for('user_profile', id=balance.id) }}" class="text-decoration-none text-dark fw-bold">{{ balance.name }}</a>
                        </td>
                        <td class="text-end fw-bold {{ 'text-success' if balance.amount_due >= 0 else 'text-danger' }}">
                            ₹{{ "%.2f"|format(balance.amount_due) }}
                        </td>
                        <td class="text-center">
                            {% if balance.amount_due > 0 %}
                            <form action="{{ url_for('pay_dues', employee_id=balance.id) }}" method="post" onsubmit="return confirm('Pay ₹{{ '%.2f'|format(balance.amount_due) }} to {{ balance.name }}?')">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-check-circle-fill"></i> Settle Dues
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted fst-italic">Cleared</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center">No active employees found.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>


<div class="row">
    <!-- Today's Present -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-success-subtle">
                <h4 class="mb-0"><i class="bi bi-person-check-fill"></i> Today's Present ({{ employees_present|length }})</h4>
            </div>
            <ul class="list-group list-group-flush">
                {% for employee in employees_present %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <a href="{{ url_for('user_profile', id=employee.id) }}" class="text-decoration-none text-dark">{{ employee.name }}</a>
                    <span class="badge" style="background-color: {{ employee.color }};">{{ employee.business_name }}</span>
                </li>
                {% else %}
                <li class="list-group-item">No employees have started their job today.</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Today's Absent -->
    <div class="col-lg-6 mb-4">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-danger-subtle">
                <h4 class="mb-0"><i class="bi bi-person-x-fill"></i> Today's Absent ({{ employees_absent|length }})</h4>
            </div>
            <ul class="list-group list-group-flush">
                {% for employee in employees_absent %}
                 <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ employee.name }}
                    <span class="badge" style="background-color: {{ employee.color }}">{{ employee.business_name }}</span>
                </li>
                {% else %}
                 <li class="list-group-item">All employees are present!</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card shadow-sm">
    <div class="card-header">
        <h4 class="mb-0"><i class="bi bi-clock-history"></i> Recent Attendance Activity</h4>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Employee</th>
                        <th>Timestamp (IST)</th>
                        <th>Event</th>
                        <th>Details</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendance in attendances %}
                    <tr>
                        <td>
                            {% if attendance.photo_path and attendance.photo_path not in ['no_photo.jpg', 'auto'] %}
                                <a href="{{ url_for('static', filename='uploads/' + attendance.photo_path) }}" target="_blank">
                                    <img src="{{ url_for('static', filename='uploads/' + attendance.photo_path) }}" alt="Check-in photo" width="50" height="50" class="rounded">
                                </a>
                            {% else %}
                                <span class="text-muted">No Photo</span>
                            {% endif %}
                        </td>
                        <td>{{ attendance.employee_name }}</td>
                        <td>{{ attendance.timestamp | ist }}</td>
                        <td>
                            {% if attendance.event_type == 'Start' %}
                            <span class="badge bg-success">Start</span>
                            {% else %}
                            <span class="badge bg-danger">End</span>
                            {% endif %}
                        </td>
                        <td>{{ attendance.details }}</td>
                        <td>{{ attendance.notes }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">No recent activity.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
