<!-- File: templates/manager/manager_dashboard.html -->
{% extends 'layout.html' %}
{% block title %}Manager Dashboard{% endblock %}
{% block content %}

<!-- Employee Balances -->
<div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="bi bi-wallet2"></i> Employee Wages Due</h4>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Employee Name</th>
                        <th class="text-end">Amount Due</th>
                        <th class="text-center">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for balance in employee_balances %}
                    <tr>
                        <td>{{ balance.name }}</td>
                        <td class="text-end fw-bold {{ 'text-success' if balance.amount_due >= 0 else 'text-danger' }}">
                            ₹{{ "%.2f"|format(balance.amount_due) }}
                        </td>
                        <td class="text-center">
                            {% if balance.amount_due > 0 %}
                            <form action="{{ url_for('manager_pay_dues', employee_id=balance.id) }}" method="post" onsubmit="return confirm('Pay ₹{{ '%.2f'|format(balance.amount_due) }} to {{ balance.name }}?')">
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-check-circle"></i> Settle Dues
                                </button>
                            </form>
                            {% else %}
                            <span class="text-muted fst-italic">Cleared</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="3" class="text-center">No active employees found in your business.</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Recent Activity -->
<div class="card shadow-sm">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h4 class="mb-0"><i class="bi bi-clock-history"></i> Recent Attendance Activity</h4>
        {% if pending_count > 0 %}
        <form action="{{ url_for('approve_all_pending') }}" method="post" onsubmit="return confirm('Are you sure you want to approve all {{ pending_count }} pending records?')">
            <button type="submit" class="btn btn-info btn-sm">
                <i class="bi bi-check2-all"></i> Approve All Pending ({{ pending_count }})
            </button>
        </form>
        {% endif %}
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0">
                <thead>
                    <tr>
                        <th>Photo</th>
                        <th>Employee</th>
                        <th>Timestamp (IST)</th>
                        <th>Event</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendance in attendances %}
                    <tr>
                        <td>
                            {% if attendance.photo_path and attendance.photo_path not in ['no_photo.jpg', 'auto'] %}
                                <a href="{{ url_for('static', filename='uploads/' + attendance.photo_path) }}" target="_blank">
                                    <img src="{{ url_for('static', filename='uploads/' + attendance.photo_path) }}" alt="Check-in photo" width="50" height="50" class="rounded">
                                </a>
                            {% else %}
                                <span class="text-muted">No Photo</span>
                            {% endif %}
                        </td>
                        <td>{{ attendance.employee_name }}</td>
                        <td>{{ attendance.timestamp | ist }}</td>
                        <td>
                            <span class="badge bg-{{ 'success' if attendance.event_type == 'Start' else 'danger' }}">{{ attendance.event_type }}</span>
                        </td>
                        <td>
                            {% if attendance.attendance_status == 'pending' %}
                            <span class="badge bg-warning text-dark">Pending</span>
                            {% elif attendance.attendance_status == 'approved' %}
                            <span class="badge bg-success">Approved</span>
                            {% elif attendance.attendance_status == 'rejected' %}
                            <span class="badge bg-danger" title="Reason: {{ attendance.rejection_reason or 'No reason provided' }}">{{ attendance.rejection_reason or 'Rejected' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if attendance.attendance_status == 'pending' %}
                            <form action="{{ url_for('approve_attendance', attendance_id=attendance.id) }}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-success btn-sm" title="Approve"><i class="bi bi-check-lg"></i></button>
                            </form>
                            <button type="button" class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#rejectModal-{{ attendance.id }}" title="Reject">
                                <i class="bi bi-x-lg"></i>
                            </button>
                            {% else %}
                            -
                            {% endif %}
                        </td>
                    </tr>
                    
                    <!-- Reject Modal -->
                    <div class="modal fade" id="rejectModal-{{ attendance.id }}" tabindex="-1">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <h5 class="modal-title">Reject Attendance for {{ attendance.employee_name }}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                          </div>
                          <form action="{{ url_for('reject_attendance', attendance_id=attendance.id) }}" method="post">
                              <div class="modal-body">
                                <p>On: {{ attendance.timestamp | ist }}</p>
                                <div class="mb-3">
                                  <label for="rejection_reason-{{ attendance.id }}" class="form-label">Reason for Rejection (e.g., blurry image, wrong location)</label>
                                  <textarea class="form-control" id="rejection_reason-{{ attendance.id }}" name="rejection_reason" rows="3" required></textarea>
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="submit" class="btn btn-danger">Confirm Rejection</button>
                              </div>
                          </form>
                        </div>
                      </div>
                    </div>
                    {% else %}
                    <tr>
                        <td colspan="6" class="text-center">No recent activity.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
